generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String                    @id @default(cuid())
  email                    String                    @unique
  name                     String
  username                 String?                   @unique
  password                 String
  avatar                   String?
  bio                      String?
  location                 String?
  website                  String?
  isPrivate                Boolean                   @default(false)
  isVerified               Boolean                   @default(false)
  emailVerified            Boolean                   @default(false)
  emailVerifiedAt          DateTime?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  canPublishLockedMedia    Boolean                   @default(false)
  posts                    Post[]
  comments                 Comment[]
  reactions                Reaction[]
  media                    Media[]
  galleries                Gallery[]
  followers                Follows[]                 @relation("UserFollowers")
  following                Follows[]                 @relation("UserFollowing")
  friendRequestsSent       FriendRequest[]           @relation("UserFriendRequestsSent")
  friendRequestsReceived   FriendRequest[]           @relation("UserFriendRequestsReceived")
  notifications            Notification[]
  searchHistory            SearchHistory[]
  mentions                 Mention[]
  mediaProcessingJobs      MediaProcessingJob[]
  conversationsCreated     Conversation[]            @relation("ConversationCreator")
  conversationParticipants ConversationParticipant[] @relation("ConversationParticipants")
  messagesSent             Message[]                 @relation("MessageSender")
  messageDeliveryStatus    MessageDeliveryStatus[]   @relation("MessageDeliveryStatus")
  messageReactions         MessageReaction[]         @relation("MessageReactions")
  userSessions             UserSession[]             @relation("UserSessions")
  unlockedPosts            UnlockedPost[]            @relation("UnlockedPosts")
  unlockedMessages         UnlockedMessage[]         @relation("UnlockedMessages")

  // New group-related relations
  groupMemberships         GroupMember[]
  groupInvitationsSent     GroupInvitation[]  @relation("GroupInvitationsSent")
  groupInvitationsReceived GroupInvitation[]  @relation("GroupInvitationsReceived")
  groupApplications        GroupApplication[] @relation("GroupApplications")
  groupApplicationReviews  GroupApplication[] @relation("GroupApplicationReviews")
  groupPostApprovals       GroupPost[]        @relation("GroupPostApprovals")
  groupPostRejections      GroupPost[]        @relation("GroupPostRejections")
  groupActions             GroupAction[]      @relation("GroupActions")

  // Facets and permissions
  lineManagerId    String?
  lineManager      User?                    @relation("LineManagement", fields: [lineManagerId], references: [id])
  directReports    User[]                   @relation("LineManagement")
  facetAssignments FacetAssignment[]
  facetHistory     FacetAssignmentHistory[]
  permissionAudits PermissionAuditLog[]
  

  @@index([lineManagerId])
  @@map("users")
}

model Post {
  id                String            @id @default(cuid())
  title             String?
  content           String
  publicationStatus PublicationStatus @default(PUBLIC)
  visibility        Visibility        @default(PUBLIC)
  authorId          String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  isLocked          Boolean           @default(false)
  unlockPrice       Int?
  author            User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments          Comment[]
  reactions         Reaction[]
  media             PostMedia[]
  hashtags          Hashtag[]
  mentions          Mention[]
  notifications     Notification[]
  unlockedBy        UnlockedPost[]    @relation("UnlockedPosts")
  groupPosts        GroupPost[] // New relation for group posts

  @@map("posts")
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  postId    String?
  authorId  String
  parentId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  mediaId   String?

  // NEW: Context tracking for comment isolation
  context CommentContext @default(FEED)
  groupId String?

  // Relations
  post          Post?          @relation(fields: [postId], references: [id], onDelete: Cascade)
  media         Media?         @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  author        User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent        Comment?       @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  replies       Comment[]      @relation("CommentReplies")
  reactions     Reaction[]
  notifications Notification[]
  group         Group?         @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@map("comments")
}

model Reaction {
  id        String       @id @default(cuid())
  type      ReactionType
  postId    String?
  commentId String?
  authorId  String
  createdAt DateTime     @default(now())
  post      Post?        @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment   Comment?     @relation(fields: [commentId], references: [id], onDelete: Restrict, onUpdate: Restrict)
  author    User         @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@unique([postId, authorId])
  @@unique([commentId, authorId])
  @@map("reactions")
}

model Media {
  id                    String               @id @default(cuid())
  url                   String
  thumbnail             String?
  s3Key                 String?
  thumbnailS3Key        String?
  originalFilename      String?
  altText               String?
  caption               String?
  width                 Int?
  height                Int?
  size                  Int?
  mimeType              String?
  tags                  String[]             @default([])
  visibility            Visibility           @default(PUBLIC)
  postId                String?
  authorId              String
  galleryId             String?
  order                 Int                  @default(0)
  mediaType             MediaType            @default(IMAGE)
  processingStatus      ProcessingStatus     @default(COMPLETED)
  duration              Float?
  codec                 String?
  bitrate               Int?
  framerate             Float?
  videoUrl              String?
  videoS3Key            String?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  videoMetadata         Json?
  videoProcessingStatus ProcessingStatus?
  videoThumbnails       Json?
  videoVersions         Json?
  imageMetadata         Json?
  imageProcessingStatus ProcessingStatus?
  imageVersions         Json?
  posts                 PostMedia[]
  author                User                 @relation(fields: [authorId], references: [id], onDelete: Cascade)
  gallery               Gallery?             @relation(fields: [galleryId], references: [id], onDelete: SetNull)
  coverForGallery       Gallery?             @relation("GalleryCover")
  groupAvatar           Group?               @relation("GroupAvatar")
  groupCoverPhoto       Group?               @relation("GroupCoverPhoto")
  comments              Comment[]
  mediaProcessingJobs   MediaProcessingJob[]
  messages              Message[]            @relation("MessageMedia")
  messageMediaItems     MessageMedia[]       @relation("MessageMediaItems")
  zipMediaId            String?              // Link to original zip file if extracted from zip
  originalPath          String?              // Original path within zip (e.g., "photos/vacation/img1.jpg")

  @@index([zipMediaId])
  @@map("media")
}

model Gallery {
  id           String     @id @default(cuid())
  name         String
  description  String?
  visibility   Visibility @default(PUBLIC)
  authorId     String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  coverMediaId String?    @unique
  author       User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  media        Media[]
  coverMedia   Media?     @relation("GalleryCover", fields: [coverMediaId], references: [id], onDelete: Restrict, onUpdate: Restrict)

  @@map("galleries")
}


model Hashtag {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  posts     Post[]

  @@map("hashtags")
}

model Mention {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@map("mentions")
}

model Follows {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@map("follows")
}

model FriendRequest {
  id         String              @id @default(cuid())
  senderId   String
  receiverId String
  status     FriendRequestStatus @default(PENDING)
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  sender     User                @relation("UserFriendRequestsSent", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User                @relation("UserFriendRequestsReceived", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@map("friend_requests")
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  userId    String
  postId    String?
  commentId String?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  post      Post?            @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment   Comment?         @relation(fields: [commentId], references: [id], onDelete: Restrict, onUpdate: Restrict)

  @@map("notifications")
}

model SearchHistory {
  id        String   @id @default(cuid())
  query     String
  userId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("search_history")
}

model PostMedia {
  id       String  @id @default(cuid())
  postId   String
  mediaId  String
  order    Int     @default(0)
  isLocked Boolean @default(false)
  post     Post    @relation(fields: [postId], references: [id], onDelete: Cascade)
  media    Media   @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([postId, mediaId])
  @@map("post_media")
}

model MediaProcessingJob {
  id               String           @id @default(cuid())
  mediaId          String
  userId           String
  mediaType        MediaType
  s3Key            String
  originalFilename String
  status           ProcessingStatus @default(PENDING)
  progress         Int              @default(0)
  currentStep      String?
  errorMessage     String?
  thumbnails       Json?
  videoVersions    Json?
  imageVersions    Json?
  metadata         Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  completedAt      DateTime?
  media            Media            @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("media_processing_jobs")
}

model Conversation {
  id            String                    @id @default(cuid())
  type          ConversationType          @default(DIRECT)
  name          String?
  avatarUrl     String?
  createdById   String
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  lastMessageAt DateTime?
  isActive      Boolean                   @default(true)
  createdBy     User                      @relation("ConversationCreator", fields: [createdById], references: [id], onDelete: Cascade)
  participants  ConversationParticipant[]
  messages      Message[]

  @@map("conversations")
}

model ConversationParticipant {
  id             String          @id @default(cuid())
  conversationId String
  userId         String
  role           ParticipantRole @default(MEMBER)
  joinedAt       DateTime        @default(now())
  leftAt         DateTime?
  isActive       Boolean         @default(true)
  conversation   Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User            @relation("ConversationParticipants", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

model Message {
  id                String                  @id @default(cuid())
  conversationId    String
  senderId          String
  content           String?
  messageType       MessageType             @default(TEXT)
  mediaId           String?
  replyToId         String?
  encryptedContent  String?
  encryptionVersion Int                     @default(1)
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  isDeleted         Boolean                 @default(false)
  isLocked          Boolean                 @default(false)
  unlockPrice       Int?
  conversation      Conversation            @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender            User                    @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  media             Media?                  @relation("MessageMedia", fields: [mediaId], references: [id], onDelete: SetNull)
  mediaItems        MessageMedia[]          @relation("MessageMediaItems")
  deliveryStatus    MessageDeliveryStatus[]
  reactions         MessageReaction[]
  unlockedBy        UnlockedMessage[]       @relation("UnlockedMessages")

  @@map("messages")
}

model MessageMedia {
  id        String  @id @default(cuid())
  messageId String
  mediaId   String
  order     Int     @default(0)
  isLocked  Boolean @default(false)
  message   Message @relation("MessageMediaItems", fields: [messageId], references: [id], onDelete: Cascade)
  media     Media   @relation("MessageMediaItems", fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([messageId, mediaId])
  @@map("message_media")
}

model MessageDeliveryStatus {
  id          String         @id @default(cuid())
  messageId   String
  userId      String
  status      DeliveryStatus @default(SENT)
  deliveredAt DateTime?
  readAt      DateTime?
  message     Message        @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user        User           @relation("MessageDeliveryStatus", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@map("message_delivery_status")
}

model MessageReaction {
  id        String   @id @default(cuid())
  messageId String
  userId    String
  reaction  String
  createdAt DateTime @default(now())
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation("MessageReactions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, reaction])
  @@map("message_reactions")
}

model UnlockedPost {
  id         String   @id @default(cuid())
  userId     String
  postId     String
  paidAmount Int
  unlockedAt DateTime @default(now())
  user       User     @relation("UnlockedPosts", fields: [userId], references: [id], onDelete: Cascade)
  post       Post     @relation("UnlockedPosts", fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@map("unlocked_posts")
}

model UnlockedMessage {
  id         String   @id @default(cuid())
  userId     String
  messageId  String
  paidAmount Int
  unlockedAt DateTime @default(now())
  user       User     @relation("UnlockedMessages", fields: [userId], references: [id], onDelete: Cascade)
  message    Message  @relation("UnlockedMessages", fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([userId, messageId])
  @@map("unlocked_messages")
}

model UserSession {
  id         String   @id @default(cuid())
  userId     String
  sessionId  String   @unique
  deviceInfo Json?
  lastSeen   DateTime @default(now())
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  user       User     @relation("UserSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

// Group Models
model Group {
  id               String                @id @default(cuid())
  name             String
  username         String                @unique
  description      String?
  rules            String?
  coverPhotoId     String?               @unique
  avatarId         String?               @unique
  visibility       GroupVisibility       @default(PRIVATE_VISIBLE)
  type             GroupType             @default(GENERAL)
  moderationPolicy GroupModerationPolicy @default(NO_MODERATION)
  isActive         Boolean               @default(true)
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  // Relations
  members         GroupMember[]
  posts           GroupPost[]
  invitations     GroupInvitation[]
  applications    GroupApplication[]
  actions         GroupAction[]
  comments        Comment[] // NEW: Group can have comments
  avatarMedia     Media?             @relation("GroupAvatar", fields: [avatarId], references: [id], onDelete: SetNull)
  coverPhotoMedia Media?             @relation("GroupCoverPhoto", fields: [coverPhotoId], references: [id], onDelete: SetNull)

  @@map("groups")
}

model GroupMember {
  id          String            @id @default(cuid())
  groupId     String
  userId      String
  role        GroupMemberRole   @default(MEMBER)
  status      GroupMemberStatus @default(ACTIVE)
  joinedAt    DateTime          @default(now())
  leftAt      DateTime?
  suspendedAt DateTime?
  bannedAt    DateTime?

  // Relations
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("group_members")
}

model GroupPost {
  id              String          @id @default(cuid())
  groupId         String
  postId          String
  status          GroupPostStatus @default(PENDING_APPROVAL)
  isPriority      Boolean         @default(false)
  approvedAt      DateTime?
  approvedBy      String?
  rejectedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  group          Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  post           Post  @relation(fields: [postId], references: [id], onDelete: Cascade)
  approvedByUser User? @relation("GroupPostApprovals", fields: [approvedBy], references: [id])
  rejectedByUser User? @relation("GroupPostRejections", fields: [rejectedBy], references: [id])

  @@unique([groupId, postId])
  @@map("group_posts")
}

model GroupInvitation {
  id            String    @id @default(cuid())
  groupId       String
  inviterId     String
  inviteeEmail  String?
  inviteeUserId String?
  inviteCode    String    @unique
  expiresAt     DateTime
  acceptedAt    DateTime?
  createdAt     DateTime  @default(now())

  // Relations
  group   Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  inviter User  @relation("GroupInvitationsSent", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee User? @relation("GroupInvitationsReceived", fields: [inviteeUserId], references: [id])

  @@map("group_invitations")
}

model GroupApplication {
  id          String              @id @default(cuid())
  groupId     String
  applicantId String
  message     String?
  status      FriendRequestStatus @default(PENDING)
  reviewedAt  DateTime?
  reviewedBy  String?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  group     Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  applicant User  @relation("GroupApplications", fields: [applicantId], references: [id], onDelete: Cascade)
  reviewer  User? @relation("GroupApplicationReviews", fields: [reviewedBy], references: [id])

  @@unique([groupId, applicantId])
  @@map("group_applications")
}

model GroupAction {
  id          String          @id @default(cuid())
  groupId     String
  userId      String
  actionType  GroupActionType
  description String
  metadata    Json?
  createdAt   DateTime        @default(now())

  // Relations
  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation("GroupActions", fields: [userId], references: [id], onDelete: Cascade)

  @@map("group_actions")
}

model HashtagToPost {
  A String
  B String

  @@unique([A, B], map: "_HashtagToPost_AB_unique")
  @@index([B], map: "_HashtagToPost_B_index")
  @@map("_HashtagToPost")
}

enum ReactionType {
  LIKE
  LOVE
  HAHA
  WOW
  SAD
  ANGRY
}

enum PublicationStatus {
  PUBLIC
  PAUSED
  CONTROLLED
  DELETED
}

enum Visibility {
  PUBLIC
  FRIENDS_ONLY
  PRIVATE
}

enum NotificationType {
  LIKE
  COMMENT
  FOLLOW
  MENTION
  FRIEND_REQUEST
  FRIEND_REQUEST_ACCEPTED
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
}

enum MediaType {
  IMAGE
  VIDEO
  ZIP
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  REJECTED
  FAILED
}

enum ConversationType {
  DIRECT
  GROUP
}

enum ParticipantRole {
  ADMIN
  MEMBER
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  FILE
  SYSTEM
  POST
}

enum DeliveryStatus {
  SENT
  DELIVERED
  READ
}

// Comment context enum for isolation
enum CommentContext {
  FEED // Comment made in user's feed
  GROUP // Comment made in a group
  USER_PAGE // Comment made on user's public page
}

// Group-related enums
enum GroupVisibility {
  PUBLIC
  PRIVATE_VISIBLE
  PRIVATE_HIDDEN
}

enum GroupType {
  GENERAL
  SOCIAL_LEARNING
  GAMING
  JOBS
  BUY_SELL
  PARENTING
  WORK
}

enum GroupMemberRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
}

enum GroupMemberStatus {
  ACTIVE
  SUSPENDED
  BANNED
  PENDING_APPROVAL
}

enum GroupPostStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
  DELETED
}


enum GroupModerationPolicy {
  NO_MODERATION
  ADMIN_APPROVAL_REQUIRED
  AI_FILTER
  SELECTIVE_MODERATION
}

enum GroupActionType {
  GROUP_CREATED
  GROUP_UPDATED
  MEMBER_JOINED
  MEMBER_LEFT
  MEMBER_PROMOTED
  MEMBER_DEMOTED
  MEMBER_SUSPENDED
  MEMBER_BANNED
  POST_APPROVED
  POST_REJECTED
  POST_DELETED
  COMMENT_APPROVED
  COMMENT_REJECTED
  COMMENT_DELETED
  RULES_UPDATED
  SETTINGS_CHANGED
}

model EmailVerification {
  id        String   @id @default(cuid())
  email     String
  code      String // 6-digit verification code
  expiresAt DateTime // Code expiration timestamp
  attempts  Int      @default(0) // Failed verification attempts
  createdAt DateTime @default(now())

  @@unique([email, code])
  @@map("email_verifications")
}

// Facets and Permissions System
model Facet {
  id             String                   @id @default(cuid())
  scope          String // e.g., "reedi-admin", "org-division", "user-role"
  name           String // e.g., "global", "moderator", "division"
  value          String                   @default("") // e.g., "engineering", "sales"
  description    String?
  requiresAudit  Boolean                  @default(true)
  expiryDays     Int? // Auto-expiry after N days
  requiresReview Boolean                  @default(false)
  reviewDays     Int? // Review required every N days
  parentFacetId  String?
  hierarchyLevel Int                      @default(0)
  isActive       Boolean                  @default(true)
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  parentFacet    Facet?                   @relation("FacetHierarchy", fields: [parentFacetId], references: [id])
  childFacets    Facet[]                  @relation("FacetHierarchy")
  assignments    FacetAssignment[]
  history        FacetAssignmentHistory[]

  @@unique([scope, name, value])
  @@index([scope, name])
  @@index([parentFacetId, hierarchyLevel])
  @@map("facets")
}

model FacetAssignment {
  id           String    @id @default(cuid())
  facetId      String
  entityType   String // "user", "media", "group", "post"
  entityId     String
  assignedById String?
  assignedAt   DateTime  @default(now())
  expiresAt    DateTime?
  reviewAt     DateTime?
  reason       String?
  metadata     Json? // Additional context
  isActive     Boolean   @default(true)
  facet        Facet     @relation(fields: [facetId], references: [id], onDelete: Cascade)
  assignedBy   User?     @relation(fields: [assignedById], references: [id])

  @@unique([facetId, entityType, entityId])
  @@index([entityType, entityId, isActive])
  @@index([expiresAt])
  @@index([reviewAt])
  @@map("facet_assignments")
}

model FacetAssignmentHistory {
  id                String      @id @default(cuid())
  facetId           String
  entityType        String
  entityId          String
  action            FacetAction // ASSIGNED, REVOKED, EXPIRED, REVIEWED, EXTENDED
  performedById     String?
  performedAt       DateTime    @default(now())
  reason            String?
  expiresAt         DateTime?
  previousExpiresAt DateTime?
  metadata          Json?
  facet             Facet       @relation(fields: [facetId], references: [id], onDelete: Cascade)
  performedBy       User?       @relation(fields: [performedById], references: [id])

  @@index([entityType, entityId, performedAt])
  @@index([facetId])
  @@index([performedAt])
  @@map("facet_assignment_history")
}

model PermissionAuditLog {
  id              String   @id @default(cuid())
  userId          String?
  resourceType    String // "media", "post", "user", etc.
  resourceId      String
  operation       String // "read", "create", "update", "delete"
  granted         Boolean
  reason          String
  reasonCode      String? // Machine-readable code
  ipAddress       String?
  userAgent       String?
  requestId       String?
  executionTimeMs Int?
  facetsChecked   Json? // Which facets were evaluated
  createdAt       DateTime @default(now())
  user            User?    @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([resourceType, resourceId])
  @@index([operation, granted])
  @@index([createdAt])
  @@map("permission_audit_logs")
}

enum FacetAction {
  ASSIGNED
  REVOKED
  EXPIRED
  REVIEWED
  EXTENDED
  MODIFIED
}
